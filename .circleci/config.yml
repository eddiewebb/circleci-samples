version: 2.1

executors:

  latest:
    docker:
    - image: cimg/base:stable

jobs:
  only:
    executor: latest
    parallelism: 20
    steps:
      - run: set
      - checkout
      - run: |
          ls -la
          pwd
          if [ $(($CIRCLE_NODE_INDEX % 2)) -eq 1 ]; then
            # all odd containers get pinned mirror.
            echo "USING MIRROR"
            sudo cp repo.list /etc/apt/sources.list
          fi
          ARCH=$(dpkg --print-architecture) # system architecture (e.g., amd64)
          VERSION='0.3.ds1-30.1'
          URL="http://ftp.debian.org/debian/pool/main/n/netselect/netselect_${VERSION}_${ARCH}.deb"
          wget $URL
          sudo apt install ./netselect_${VERSION}_${ARCH}.deb
          wget -q -O- https://launchpad.net/ubuntu/+archivemirrors > mirrors.txt
          grep -P -B8 "statusUP" mirrors.txt | grep -o -P "(f|ht)tp://[^\"]*" > filtered_mirrors.txt

      - store_artifacts:
          path: filtered_mirrors.txt

      - run: |
          sudo apt update
      - run: |
          sudo apt install -y php nginx python3
          
          




  
workflows:
  test-deploy:
    jobs:
      - only:
          name: do stuff