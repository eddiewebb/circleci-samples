version: 2.1
setup: true

parameters:
  invocation:
    type: string
    default: "1"
  keep-going:
    type: boolean
    default: true
  continuation-key:
    type: string
    default: ""
  

orbs:
  continuation: circleci/continuation@0.2.0

executors:
  default:
    docker:
      - image: cimg/node:14.18.2

jobs:
  keep-going:
    executor: default
    resource_class: small
    steps:
      - run: echo <<pipeline.parameters.invocation>>
      - checkout
      - run:
          name: mock continuation config
          command: |
            cat .circleci/config.yml | sed 's/setup: true/setup: false/' > gogo.yml
      - when:
          condition:
            equal: [ "1", <<pipeline.parameters.invocation>> ]
          steps:            
            - continuation/continue:
                configuration_path: gogo.yml
                parameters: '{"keep-going":true, "invocation":"2","continuation-key":"'$CIRCLE_CONTINUATION_KEY'"}'
      - when:
          condition:
            equal: [ "2", <<pipeline.parameters.invocation>> ]
          steps:            
            - echo "export CIRCLE_CONTINUATION_KEY=<<pipeline.parameters.continuation-key>> >> $BASH_ENV"
            - continuation/continue:
                configuration_path: gogo.yml
                parameters: '{"keep-going":false, "invocation":"3"}'

  stop:
    executor: default
    resource_class: small
    steps:
      - run: echo "all done"

  
workflows:
  version: 2
  test-deploy:
    when: <<pipeline.parameters.keep-going>>
    jobs:
      - keep-going:
          name: workflow-<<pipeline.parameters.invocation>>
  stop:
    unless: <<pipeline.parameters.keep-going>>
    jobs:
      - stop