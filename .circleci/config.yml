version: 2.1

executors:

  latest:
    docker:
    - image: cimg/base:stable
    - image: docker.nexus.namer.circleci-fieldeng.com/eddie/talktome
      name: bob
      environment:
        LISTEN_HOST: 0.0.0.0
        LISTEN_PORT: 4000
        TARGET_HOST_PORTS: jill:5000,localhost:3000
    - image: docker.nexus.namer.circleci-fieldeng.com/eddie/talktome
      name: jill
      environment:
        LISTEN_HOST: 0.0.0.0
        LISTEN_PORT: 5000
        TARGET_HOST_PORTS: bob:4000,localhost:3000

jobs:
  only:
    executor: latest
    steps:
      - run:
          name: listen
          command: nc -l 0.0.0.0 3000 
          background: true
      - run: |
          sleep 10
          nc -w 2 -v jill 5000 || echo "nope"
          nc -w 2 -v bob 4000 || echo "nope"
          sleep 10
          
          




  
workflows:
  test-deploy:
    jobs:
      - only:
          name: do stuff