version: 2.1

parameters:
  version_to_promote:
    default: ""
    type: string

workflows:
  build:
    unless: << pipeline.parameters.version_to_promote >>
    jobs:
      - build

  promote:
    when: << pipeline.parameters.version_to_promote >>
    jobs:
      - approve:
          type: approval
      - deploy:
         requires:
            - approve

jobs:
  build:
    docker:
    - image: circleci/node:10
    steps:
    - run: |
        echo "This build creates the artifact and publishes to an artifact repo or container registry."
        echo "Alternately it could attach artifacts to the workflow in CircleCI."
        echo "<< pipeline.number >>"
    - run: |
        curl -X POST "https://circleci.com/api/v2/project/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/pipeline?circle-token=${CIRCLE_TOKEN}" -H "Accept: application/json" -H "Content-Type: application/json" -d "{ \"branch\":\"${CIRCLE_BRANCH}\",\"parameters\": {\"version_to_promote\":\"2.0.6\"}}"
  
  deploy:
    docker:
    - image: circleci/node:10
    steps:
    - run: |
        echo "Deploying: <<pipeline.parameters.version_to_promote>>"
   