version: 2.1

orbs:
  secret-provider:
    commands:
      prepare-secrets:
        parameters:
          # if using non-BASH images (alpine uses ash, others might have zsh, change profle path to match)
          # https://circleci.com/docs/2.0/env-vars/#using-parameters-and-bash-environment
          profile-path:
            type: string
            default: $BASH_ENV
        steps:
          - run:
              name: Setup deployment secrets for current branch
              command: |
                # decide which set of variables to rename.
                echo "Evaluating suffix based on branch name: ${CIRCLE_BRANCH}"
                SUFFIX="_DEV"
                case "${CIRCLE_BRANCH}" in
                  main)
                    SUFFIX="_production"
                    ;;
                  master)
                    SUFFIX="_production"
                    ;;
                  stag*)
                    SUFFIX="_staging"
                    ;;
                  *)
                    echo "Current branch does not match policy, default to dev secrets."
                    ;;
                esac
                echo "Secret suffix set to: ${SUFFIX}"
                # use suffix to rename secrets
                for secret in `env | grep -i "${SUFFIX}="`; do
                  source_key=${secret/=*/}
                  target_key=${secret/$SUFFIX*/}
                  echo "Found matching env. variable named: ${source_key} to copy over as ${target_key}"
                  echo "export ${secret/$SUFFIX*/}=${secret/*$SUFFIX=/}" >> <<parameters.profile-path>>
                done
                cat <<parameters.profile-path>>





executors:
  base:
    docker:
      - image: cimg/base:2021.07

jobs:
  deploy:
    executor: base
    resource_class: small
    steps:
      - checkout
      - secret-provider/prepare-secrets
      - run:
          env
          echo ${MY_SECRET}


workflows:
  primary:
    jobs:
      - deploy
            